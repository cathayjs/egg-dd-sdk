
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#about" class="toc-h1 toc-link" data-title="About">About</a>
          </li>
          <li>
            <a href="#dd-config" class="toc-h1 toc-link" data-title="DD-CONFIG">DD-CONFIG</a>
          </li>
          <li>
            <a href="#dd-utils" class="toc-h1 toc-link" data-title="DD-utils">DD-utils</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#aes-encode" class="toc-h2 toc-link" data-title="DD-utils">aes.encode()</a>
                  </li>
                  <li>
                    <a href="#aes-decode" class="toc-h2 toc-link" data-title="DD-utils">aes.decode()</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#dd-service-api" class="toc-h1 toc-link" data-title="DD-Service API">DD-Service API</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#general-service" class="toc-h2 toc-link" data-title="DD-Service API">General Service</a>
                  </li>
                  <li>
                    <a href="#user-service" class="toc-h2 toc-link" data-title="DD-Service API">User Service</a>
                  </li>
                  <li>
                    <a href="#department-service" class="toc-h2 toc-link" data-title="DD-Service API">Department Service</a>
                  </li>
                  <li>
                    <a href="#sns-service" class="toc-h2 toc-link" data-title="DD-Service API">SNS Service</a>
                  </li>
                  <li>
                    <a href="#events-service" class="toc-h2 toc-link" data-title="DD-Service API">Events Service</a>
                  </li>
                  <li>
                    <a href="#process-service" class="toc-h2 toc-link" data-title="DD-Service API">Process Service</a>
                  </li>
              </ul>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='https://github.com/tripit/slate'>Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='about'>About</h1>
<p>由于钉钉未提供nodejs sdk，初次用nodejs对应相应接口时比较费时费力，所以将项目中的钉钉对接接口整理出来，以<code>egg插件</code>的方式提供呈现。</p>

<p>本sdk的主要达到三个目的：</p>

<ol>
<li>config: 钉钉相关配置的约定</li>
<li>utils: 将钉钉加解密之类的复杂方法抽象为工具类</li>
<li>service: 将与钉钉相关的API接口进行封装，以service方式提供，方便调用</li>
</ol>

<p>另外，关于为什么基于<code>egg插件</code>，说明一下原因：</p>

<ol>
<li><code>egg</code>框架本身在企业级应用框架中的分层非常清晰，扩展机制极其灵活，配套完整，极力推荐</li>
<li>通过<code>egg插件</code>的组织，能够非常方便的组织钉钉的配置文件管理、工具使用及service使用

<ol>
<li>提供了统一的配置管理</li>
<li>提供统一的工具调用方式</li>
<li>提供统一的service调用方式</li>
<li>统一的日志服务</li>
</ol></li>
</ol>

<aside class="notice">
自己参与的项目非ISV类型，未针对ISV做设计，有需求的同学可以一起参与完善。
</aside>
<h1 id='dd-config'>DD-CONFIG</h1>
<blockquote>
<p>在config/config.default.js中</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>  <span class="nx">exports</span><span class="p">.</span><span class="nx">DD_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">corpId</span><span class="p">:</span> <span class="s2">"dinge0e69ed313daa460"</span><span class="p">,</span>
    <span class="na">secret</span><span class="p">:</span> <span class="s2">"sH_JdRrkgRvmJ5B9_RPjAM51hgT9cXhxCl0-_kUDY5_VOuhPX_PbIoKsigoyEqLd"</span><span class="p">,</span>
    <span class="na">agentId</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'default'</span><span class="p">:</span> <span class="s1">'103015601'</span><span class="p">,</span>
      <span class="s1">'applyAndApprove'</span><span class="p">:</span> <span class="s1">'84637933'</span><span class="p">,</span>
      <span class="s1">'sso'</span><span class="p">:</span> <span class="s1">'103015601'</span>
    <span class="p">},</span>
    <span class="na">aesKey</span><span class="p">:</span> <span class="s2">"1234567890123456789012345678901234567890abc"</span><span class="p">,</span>
    <span class="na">token</span><span class="p">:</span> <span class="s2">"abcdef"</span><span class="p">,</span>
    <span class="na">nonceStr</span><span class="p">:</span> <span class="s2">"123456"</span><span class="p">,</span>
    <span class="na">sso</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">appId</span><span class="p">:</span> <span class="s2">"dingoakznbgimtvtwk49i1"</span><span class="p">,</span>
      <span class="na">appSecret</span><span class="p">:</span> <span class="s2">"dlDOTzrLsB5XV5aciVsgEu_76KatMgbWgsWJkxsE54fY64D22MIs2ccXkqH6k5gK"</span>
    <span class="p">}</span>
  <span class="p">};</span>
</code></pre>
<blockquote>
<p>注意<code>DD_CONFIG</code>关键词</p>
</blockquote>

<p>钉钉通信中会涉及安全认证、加解密、签名验证等诸多操作，所以有各类key,token等用于上述过程：</p>

<table><thead>
<tr>
<th>字段你</th>
<th>格式</th>
<th>说明</th>
</tr>
</thead><tbody>
<tr>
<td>coprId</td>
<td><code>String</code></td>
<td>公司唯一标识</td>
</tr>
<tr>
<td>secret</td>
<td><code>String</code></td>
<td>认证密钥，非常重要，妥善保管，具有极高权限</td>
</tr>
<tr>
<td>agentId</td>
<td><code>Sring</code> or <code>Object</code></td>
<td>微应用的ID</td>
</tr>
<tr>
<td>agentId(String)</td>
<td><code>String</code></td>
<td>当只有一个微应用时</td>
</tr>
<tr>
<td>agentId(Object)</td>
<td>{key, value} = <code>Object</code></td>
<td>其中 key 为 <code>agentIdType</code>, value为对应值</td>
</tr>
<tr>
<td>aesKey</td>
<td><code>String</code>(43)</td>
<td>AES加解密时需要的一个secretKey，长度43位，自己定义</td>
</tr>
<tr>
<td>token</td>
<td><code>String</code>(6)</td>
<td>aes加解密及签名时用到, len=6</td>
</tr>
<tr>
<td>nonceStr</td>
<td><code>String</code>(6)</td>
<td>aes加解密及签名时用到, len=6</td>
</tr>
<tr>
<td>sso.appId</td>
<td><code>String</code></td>
<td>钉钉扫码登陆的appId</td>
</tr>
<tr>
<td>sso.appSecret</td>
<td><code>String</code></td>
<td>钉钉扫码登陆的appSecret</td>
</tr>
</tbody></table>
<h1 id='dd-utils'>DD-utils</h1>
<blockquote>
<p>钉钉通信加解密:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// step1: createInstance</span>
<span class="kd">let</span> <span class="nx">aes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">helper</span><span class="p">.</span><span class="nx">createDdEncrpt</span><span class="p">();</span>
<span class="c1">// step2: encode(encodeString, timestamp, nonceString);</span>
<span class="kd">let</span> <span class="nx">encoded</span> <span class="o">=</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="mi">1500957302881</span><span class="p">,</span> <span class="s1">'KOHjp9ss'</span><span class="p">);</span>
<span class="c1">// console.log(encoded);</span>
<span class="c1">// step3: decode(decodeString, timestamp, nonceString, decodeStringSignature)</span>
<span class="kd">let</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">timeStamp</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">nonce</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">msg_signature</span><span class="p">);</span>
<span class="c1">// console.log(parsed)</span>
</code></pre>
<p>使用钉钉的部分接口，需要进行<code>加解密</code>以及<code>签名验证</code>操作，签名相对简单，但加解密涉及大量编码转换以及算法知识，在缺乏相关知识背景的情况下，很难完成。官方仅提供了PHP,JAVA SDK，自己摸索了半天才搞定了Nodejs版的部分。</p>

<p>我们提供了: <code>this.helper.createDdEncrpt()</code>方法</p>

<p>官方文档：<a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.8b5CcM&amp;treeId=366&amp;articleId=104945&amp;docType=1#s13">钉钉加解密及签名验证</a></p>

<p>另外提供了非egg版本，参见：<a href="https://github.com/cathayjs/nodejs-dd-aes">nodejs-dd-aes</a></p>

<aside class="notice">
进行加解密，必须配置`aesKey`, `token`
</aside>
<h2 id='aes-encode'>aes.encode()</h2><pre class="highlight javascript tab-javascript"><code><span class="c1">// step2: encode(encodeString, timestamp, nonceString);</span>
<span class="kd">let</span> <span class="nx">encoded</span> <span class="o">=</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="mi">1500957302881</span><span class="p">,</span> <span class="s1">'KOHjp9ss'</span><span class="p">);</span>
<span class="c1">// console.log(encoded);</span>
</code></pre>
<ul>
<li>encodeString: 要加密的原始字符串（你要发给钉钉的原始字符串）</li>
<li>timestamp: 随机时间戳，毫秒时</li>
<li>nonceString: 随机nonce字符，6位</li>
</ul>
<h2 id='aes-decode'>aes.decode()</h2><pre class="highlight javascript tab-javascript"><code><span class="c1">// step3: decode(decodeString, timestamp, nonceString, decodeStringSignature)</span>
<span class="kd">let</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">timeStamp</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">nonce</span><span class="p">,</span> <span class="nx">encoded</span><span class="p">.</span><span class="nx">msg_signature</span><span class="p">);</span>
<span class="c1">// console.log(parsed)</span>
</code></pre>
<ul>
<li>decodeString：解密钉钉发给你的加密字符串</li>
<li>timestamp: 加密字符串配对的timestamp(钉钉会同加密字符串一起发给你)</li>
<li>nonceString: 加密字符串配对的nonceString(钉钉会同加密字符串一起发给你)</li>
<li>decodeStringSignature: 加密字符串配对的decodeStringSignature(钉钉会同加密字符串一起发给你)</li>
</ul>
<h1 id='dd-service-api'>DD-Service API</h1>
<p>service是SDK的核心, 对常见的 dd api 进行了封装~</p>

<aside class="notice">
关于性能优化：所有service与钉钉通信时都有一个`accessToken`授权认证的过程，为了提高性能需要把`accessToken`缓存下来。
`egg-dd-sdk`中处理了这部分的性能优化，需要你在egg框架中启用`egg-redis`插件。如果未启用，则不进行accessToken缓存策略。
</aside>
<h2 id='general-service'>General Service</h2><h3 id='code-this-ctx-service-dd-gettoken-code'><code>this.ctx.service.dd.getToken()</code></h3><h3 id='code-this-ctx-service-dd-sendmessagebydduserid-dduserid-messageobj-agentidtype-code'><code>this.ctx.service.dd.sendMessageByDdUserId(ddUserId, messageObj, agentIdType)</code></h3>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7386797.0.0.rD6Zgg&amp;treeId=172&amp;articleId=104973&amp;docType=1">钉钉官方文档-企业会话消息接口</a></li>
<li><a href="https://open-doc.dingtalk.com/doc2/detail.htm?spm=a219a.7629140.0.0.HTFncJ&amp;treeId=172&amp;articleId=104972&amp;docType=1">钉钉官方文档-消息类型及数据格式</a></li>
</ul>
<h3 id='code-this-ctx-service-dd-getjsapiconfig-originurl-agentidtype-code'><code>this.ctx.service.dd.getJsApiConfig(originUrl, agentIdType)</code></h3>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.qw2yFM&amp;treeId=171&amp;articleId=104910&amp;docType=1">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-dd-getuserinfo-code-code'><code>this.ctx.service.dd.getUserInfo(code)</code></h3>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.p1ESs4&amp;treeId=172&amp;articleId=104969&amp;docType=1">钉钉官方文档</a></li>
</ul>
<h2 id='user-service'>User Service</h2>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.6nS7Sz&amp;treeId=172&amp;articleId=104979&amp;docType=1#s6">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-dduser-getuser-userid-code'><code>this.ctx.service.ddUser.getUser(userId)</code></h3><h3 id='code-this-ctx-service-dduser-getusers-departmentid-casade-true-code'><code>this.ctx.service.ddUser.getUsers(departmentId, casade = true)</code></h3>
<p>钉钉官方api中无法递归获取部门中的员工数据，本接口封装了这部分，当<code>casade=true</code>时，递归后去，默认为true</p>
<h3 id='code-this-ctx-service-dduser-getusersbydepartment-departmentid-code'><code>this.ctx.service.ddUser.getUsersByDepartment(departmentId)</code></h3>
<p>钉钉官方api获取部门用户时，会有分页概念，本接口屏蔽了分页逻辑，默认返回返回部门下的所有员工。</p>
<h3 id='code-this-ctx-service-dduser-createuser-userinfo-code'><code>this.ctx.service.ddUser.createUser(userInfo)</code></h3><h3 id='code-this-ctx-service-dduser-updateuser-userinfo-code'><code>this.ctx.service.ddUser.updateUser(userInfo)</code></h3><h3 id='code-this-ctx-service-dduser-deleteuser-userid-code'><code>this.ctx.service.ddUser.deleteUser(userId)</code></h3><h2 id='department-service'>Department Service</h2>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.W4WlHX&amp;treeId=172&amp;articleId=104979&amp;docType=1#s0">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-getdepartment-departmentid-code'><code>this.ctx.service.getDepartment(departmentId)</code></h3><h3 id='code-this-ctx-service-getdepartments-parentid-code'><code>this.ctx.service.getDepartments(parentId)</code></h3><h3 id='code-this-ctx-service-updatedepartment-departmentinfo-code'><code>this.ctx.service.updateDepartment(departmentInfo)</code></h3><h3 id='code-this-ctx-service-deletedepartment-departmentid-code'><code>this.ctx.service.deleteDepartment(departmentId)</code></h3><h2 id='sns-service'>SNS Service</h2>
<ul>
<li><a href="https://open-doc.dingtalk.com/doc2/detail.htm?spm=a219a.7629140.0.0.WiN1vd&amp;treeId=172&amp;articleId=104968&amp;docType=1#s0">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-gettoken-code'><code>this.ctx.service.getToken()</code></h3><h3 id='code-this-ctx-service-getpersistentcode-tmpauthcode-code'><code>this.ctx.service.getPersistentCode(tmpAuthCode)</code></h3><h3 id='code-this-ctx-service-getsnstoken-persistentcodeoptions-code'><code>this.ctx.service.getSnsToken(persistentCodeOptions)</code></h3><h3 id='code-this-ctx-service-getuserinfo-snstoken-code'><code>this.ctx.service.getUserInfo(snsToken)</code></h3><h3 id='code-this-ctx-service-getuserbypersistentcode-persistentcode-code'><code>this.ctx.service.getUserByPersistentCode(persistentCode)</code></h3><h2 id='events-service'>Events Service</h2>
<ul>
<li><a href="https://open-doc.dingtalk.com/doc2/detail.htm?spm=a219a.7629140.0.0.WiN1vd&amp;treeId=172&amp;articleId=104968&amp;docType=1#s0">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-registerevents-callbackurl-events-isupdate-false-code'><code>this.ctx.service.registerEvents(callbackUrl, events, isUpdate = false)</code></h3><h3 id='code-this-ctx-service-updateevents-events-code'><code>this.ctx.service.updateEvents(events)</code></h3><h3 id='code-this-ctx-service-deleteevents-code'><code>this.ctx.service.deleteEvents()</code></h3><h3 id='code-this-ctx-service-queryevents-code'><code>this.ctx.service.queryEvents()</code></h3><h2 id='process-service'>Process Service</h2>
<ul>
<li><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.rgrrdz&amp;treeId=355&amp;articleId=29498&amp;docType=2">钉钉官方文档</a></li>
</ul>
<h3 id='code-this-ctx-service-createprocess-options-code'><code>this.ctx.service.createProcess(options)</code></h3><h3 id='code-this-ctx-service-listprocess-code'><code>this.ctx.service.listProcess()</code></h3>
      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
